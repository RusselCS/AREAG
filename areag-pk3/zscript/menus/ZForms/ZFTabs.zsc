class ZFTabs : ZFElementContainer {
	protected Array<ZFRadioButton> tabLabels;
	protected Array<ZFFrame> tabFrames;
	protected ZFRadioController curTab;

	protected double tabHeight;
	double getTabHeight() { return self.tabHeight; }
	void setTabHeight(double tabHeight) { self.tabHeight = tabHeight; }

	protected double tabLabelMargin;
	double getTabLabelMargin() { return self.tabLabelMargin; }
	void setTabLabelMargin(double tabLabelMargin) { self.tabLabelMargin = tabLabelMargin; }

	protected Font tabFont;
	Font getTabFont() { return self.tabFont; }
	void setTabFont(Font tabFont) {
		if (tabFont == NULL) {
			self.tabFont = smallfont;
		}
		else {
			self.tabFont = tabFont;
		}
	}

	protected double tabTextScale;
	double getTabTextScale() { return self.tabTextScale; }
	void setTabTextScale(double tabTextScale) { self.tabTextScale = tabTextScale; }

	protected ZFBoxTextures tabNormal;
	ZFBoxTextures getTabNormalTexture() { return self.tabNormal; }
	void setTabNormalTexture(ZFBoxTextures tabNormal) { self.tabNormal = tabNormal; setTabLabelBoxes(); }

	protected ZFBoxTextures tabHover;
	ZFBoxTextures getTabHoverTexture() { return self.tabHover; }
	void setTabHoverTexture(ZFBoxTextures tabHover) { self.tabHover = tabHover; setTabLabelBoxes(); }

	protected ZFBoxTextures tabActive;
	ZFBoxTextures getTabActiveTexture() { return self.tabActive; }
	void setTabActiveTexture(ZFBoxTextures tabActive) { self.tabActive = tabActive; setTabLabelBoxes(); }

	protected uint tabFocus;

	protected int lastTab;

	protected bool setBoxes;
	void setTabLabelBoxes() {
		if (setBoxes) {
			double curX = 0.0;
			for (int i = 0; i < tabLabels.size(); i++) {
				let l = tabLabels[i];
				l.setBox((curX, 0.0), (tabFont.stringWidth(l.getText()) * tabTextScale + 2.0 * tabLabelMargin, tabHeight));
				l.config(curTab, i, tabNormal, tabHover, tabActive, NULL, l.getText(), tabFont, tabTextScale);
				curX += l.box.size.x;
			}
		}
	}
	
	void config(
		double tabHeight, double tabLabelMargin, Font tabFont = NULL, double tabTextScale = 1.0,
		ZFBoxTextures tabNormal = NULL, ZFBoxTextures tabHover = NULL, ZFBoxTextures tabActive = NULL
	) {
		self.setBoxes = false;

		setTabHeight(tabHeight);
		setTabLabelMargin(tabLabelMargin);
		setTabFont(tabFont);
		setTabTextScale(tabTextScale);
		setTabNormalTexture(tabNormal);
		setTabHoverTexture(tabHover);
		setTabActiveTexture(tabActive);
		setAlpha(1.0);

		self.setBoxes = true;

		setTabLabelBoxes();
	}

	static ZFTabs create(
		Vector2 pos, Vector2 size,
		double tabHeight, double tabLabelMargin, Font tabFont = NULL, double tabTextScale = 1.0,
		ZFBoxTextures tabNormal = NULL, ZFBoxTextures tabHover = NULL, ZFBoxTextures tabActive = NULL
	) {
		let ret = new("ZFTabs");

		ret.setBox(pos, size);
		ret.curTab = new("ZFRadioController");
		ret.config(tabHeight, tabLabelMargin, tabFont, tabTextScale, tabNormal, tabHover, tabActive);

		return ret;
	}

	override void getFocusAABB(ZFAABB box) {
		let label = tabLabels[tabFocus];
		box.pos = label.relToMainFrame((0, 0));
		box.size = label.box.size;
	}

	override void beenFocused(ZFNavEventType type) {
		switch (type) {
		case ZFNavEventType_Left: tabFocus = tabLabels.size() - 1; break;

		case ZFNavEventType_Right:
		case ZFNavEventType_Tab:
			tabFocus = 0; break;

		case ZFNavEventType_Down:
		case ZFNavEventType_Up:
			tabFocus = curTab.curVal; break;
		}
	}

	void showCorrectTab() {
		for (int i = 0; i < tabFrames.size(); i++) {
			if (i == curTab.curVal) { tabFrames[i].show(); }
			else { tabFrames[i].hide(); }
		}
	}

	void addTab(string label) {
		let button = ZFRadioButton.create((0, 0), (0, 0), curTab, 0, text: label);
		let frame = ZFFrame.create((0.0, tabHeight), (box.size.x, box.size.y - tabHeight));

		button.master = self;
		frame.master = self;

		elements.push(button);
		elements.push(frame);

		tabLabels.push(button);
		tabFrames.push(frame);

		setTabLabelBoxes();

		showCorrectTab();
	}

	ZFFrame getTabFrame(int index) {
		return tabFrames[index];
	}

	override void topDrawer() {
		if (curTab.curVal != lastTab) {
			lastTab = curTab.curVal;
			showCorrectTab();
		}
		Super.topDrawer();
	}

	override void drawer() {
		if (curTab.curVal != lastTab) {
			lastTab = curTab.curVal;
			showCorrectTab();
		}
		Super.drawer();
	}

	override bool onNavEvent(ZFNavEventType type, bool fromController) {
		if (isFocused() && isEnabled()) {
			switch (type) {
			case ZFNavEventType_Right:
				if (tabFocus != tabLabels.size() - 1) {
					tabFocus += 1;
					return true;
				}
				break;
			case ZFNavEventType_Left:
				if (tabFocus != 0) {
					tabFocus -= 1;
					return true;
				}
				break;
			case ZFNavEventType_Confirm:
				curTab.curVal = tabFocus;
				break;
			}
		}
		return Super.onNavEvent(type, fromController);
	}

}
